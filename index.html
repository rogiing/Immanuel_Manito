<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>❤️임마누엘교회 마니또❤️ 추첨기</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            padding: 40px 50px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            border-top: 5px solid #e74c3c;
        }
        h1 {
            color: #e74c3c;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        label {
            display: block;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #555;
            font-weight: 600;
        }
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1.1em;
            background-color: #f9f9f9;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000%22%20d%3D%22M287%2069.4L146.2%20205.9%205.4%2069.4c-1.8-2.6-4.9-4.2-8.4-4.2H8.4c-3.5%200-6.6%201.6-8.4%204.2l140.8%20164.2c2.2%202.4%205.5%203.8%209%203.8s6.8-1.4%209-3.8l140.8-164.2c-1.8-2.6-4.9-4.2-8.4-4.2h-21.2c-3.5%200-6.6%201.6-8.4%204.2z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 12px;
        }
        button {
            background-color: #e74c3c;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 5px;
            min-width: 150px;
        }
        button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 30px;
            font-size: 1.5em;
            color: #28a745;
            font-weight: bold;
            background-color: #e6ffe6;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #d4ffd4;
            display: none; /* 초기에는 숨김 */
        }
        #message {
            margin-top: 20px;
            font-size: 1.1em;
            color: #555;
        }
        .admin-section {
            margin-top: 40px;
            padding: 30px;
            background-color: #f0f8ff;
            border-radius: 12px;
            border: 1px dashed #a0d2ff;
        }
        .admin-section h2 {
            color: #3498db;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .admin-section input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #b2e0ff;
            border-radius: 6px;
            font-size: 1.1em;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        .admin-section button {
            background-color: #3498db;
            margin-left: 10px;
        }
        .admin-section button:hover {
            background-color: #2980b9;
        }
        @media (max-width: 600px) {
            .container {
                padding: 25px 30px;
            }
            h1 {
                font-size: 2em;
            }
            button {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>❤️임마누엘교회 마니또❤️</h1>
        
        <div class="section">
            <label for="memberName">팀원 선택:</label>
            <select id="memberName">
                <option value="">이름을 선택해주세요</option>
                <option value="김세록">김세록</option>
                <option value="전준형">전준형</option>
                <option value="유병우">유병우</option>
                <option value="김기경">김기경</option>
                <option value="유준범">유준범</option>
                <option value="정헌">정헌</option>
                <option value="전병훈">전병훈</option>
                <option value="최지현">최지현</option>
                <option value="허다은">허다은</option>
                <option value="조재은">조재은</option>
                <option value="이우진">이우진</option>
                <option value="권민지">권민지</option>
                <option value="김지용">김지용</option>
                <option value="김민상">김민상</option>
                <option value="박동연">박동연</option>
                <option value="박상민">박상민</option>
                <option value="최하은">최하은</option>
                <option value="김민교">김민교</option>
                <option value="이단비">이단비</option>
                <option value="이하은">이하은</option>
                <option value="장현숙">장현숙</option>
                <option value="유성길">유성길</option>
                <option value="김예빈">김예빈</option>
                <option value="박주언">박주언</option>
                <option value="곽해리나">곽해리나</option>
                <option value="김기현">김기현</option>
                <option value="장서연">장서연</option>
                <option value="김이지">김이지</option>
                <option value="김재빈">김재빈</option>
                <option value="함이현">함이현</option>
                <option value="박재민">박재민</option>
                <option value="이유림">이유림</option>
                <option value="최대규 목사님">최대규 목사님</option>
            </select>
            <button id="drawButton">마니또 추첨</button>
            <p id="result">당신의 마니또는 <span id="manitoName"></span> 입니다!</p>
            <p id="message"></p>
        </div>

        <div class="admin-section">
            <h2>디렉터 전용</h2>
            <input type="password" id="adminPassword" placeholder="비밀번호를 입력하세요">
            <button id="showAdminOptionsButton">확인</button>
            <div id="adminOptions" style="display: none;">
                <button id="downloadTxtButton">결과 다운로드 (TXT)</button>
                <button id="downloadXlsxButton">결과 다운로드 (XLSX)</button>
                <button id="resetButton">모든 기록 초기화</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const members = [
            "김세록", "전준형", "유병우", "김기경", "유준범", "정헌", "전병훈", 
            "최지현", "허다은", "조재은", "이우진", "권민지", "김지용", "김민상", 
            "박동연", "박상민", "최하은", "김민교", "이단비", "이하은", "장현숙", 
            "유성길", "김예빈", "박주언", "곽해리나", "김기현", "장서연", "김이지", 
            "김재빈", "함이현", "박재민", "이유림", "최대규 목사님" 
        ];
        // 로컬 스토리지에서 기존 데이터 불러오기
        const assignedManitos = JSON.parse(localStorage.getItem('assignedManitos')) || {};
        const drawnMembers = JSON.parse(localStorage.getItem('drawnMembers')) || {}; 
        const ADMIN_PASSWORD = "21236688";

        // 현재 접속한 사용자가 선택한 이름 (브라우저별로 고정)
        let currentUser = localStorage.getItem('currentUserManitoDrawer');

        const memberSelect = document.getElementById('memberName');
        const drawButton = document.getElementById('drawButton');
        const resultDisplay = document.getElementById('result');
        const manitoNameSpan = document.getElementById('manitoName');
        const messageDisplay = document.getElementById('message');
        const adminPasswordInput = document.getElementById('adminPassword');
        const showAdminOptionsButton = document.getElementById('showAdminOptionsButton');
        const adminOptionsDiv = document.getElementById('adminOptions');
        const downloadTxtButton = document.getElementById('downloadTxtButton');
        const downloadXlsxButton = document.getElementById('downloadXlsxButton');
        const resetButton = document.getElementById('resetButton');

        // 드롭다운 옵션 초기화 및 현재 사용자 이름 설정
        function initializeMemberSelection() {
            // 모든 옵션 제거 후 새로 추가 (혹시 모를 중복 방지)
            memberSelect.innerHTML = '<option value="">이름을 선택해주세요</option>';

            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                
                // 이미 추첨을 완료한 사람은 드롭다운에서 비활성화 (선택 불가능)
                if (drawnMembers[member]) {
                    option.disabled = true;
                    option.style.backgroundColor = '#f0f0f0';
                    option.style.color = '#999';
                }
                
                memberSelect.appendChild(option);
            });

            if (currentUser) {
                // 이미 선택된 사용자가 있다면 해당 이름을 고정하고 드롭다운 비활성화
                memberSelect.value = currentUser;
                memberSelect.disabled = true; 
                messageDisplay.textContent = `${currentUser}님, 환영합니다! 마니또를 추첨하거나 결과를 확인하세요.`;
                messageDisplay.style.color = '#3498db';

                // 이미 마니또를 추첨했다면 결과 표시 및 추첨 버튼 비활성화
                if (assignedManitos[currentUser]) {
                    manitoNameSpan.textContent = assignedManitos[currentUser];
                    resultDisplay.style.display = 'block';
                    drawButton.disabled = true; 
                    messageDisplay.textContent = `${currentUser}님, 이미 추첨하셨습니다. 당신의 마니또는 ${assignedManitos[currentUser]} 입니다!`;
                    messageDisplay.style.color = '#28a745';
                } else if (drawnMembers[currentUser]) {
                     // 추첨은 했지만 결과가 화면에 숨겨져 있는 경우 (재접속)
                    drawButton.disabled = false; // 다시 누르면 결과 볼 수 있도록 활성화
                    messageDisplay.textContent = `${currentUser}님, 이미 추첨하셨습니다. 결과를 다시 보려면 '마니또 추첨' 버튼을 눌러주세요.`;
                    messageDisplay.style.color = '#28a745';
                } else {
                    // 사용자 고정 후 아직 추첨하지 않은 경우
                    drawButton.disabled = false;
                }

            } else {
                // 첫 접속이거나 초기화된 경우: 이름을 선택하기 전까지 추첨 버튼 비활성화
                messageDisplay.textContent = '먼저 드롭다운에서 자신의 이름을 선택해주세요.';
                messageDisplay.style.color = '#555';
                memberSelect.disabled = false; // 처음에는 드롭다운 활성화
                drawButton.disabled = true; 
            }
        }

        // 페이지 로드 시 초기화 함수 실행
        document.addEventListener('DOMContentLoaded', initializeMemberSelection);

        // 이름 선택 시 동작 (사용자 고정 로직)
        memberSelect.addEventListener('change', () => {
            const selected = memberSelect.value;
            if (selected && !currentUser) { // 이름이 선택되었고 아직 사용자가 고정되지 않았다면
                currentUser = selected;
                localStorage.setItem('currentUserManitoDrawer', currentUser); // 현재 사용자 이름 로컬 스토리지에 저장
                memberSelect.disabled = true; // 드롭다운 자체를 비활성화하여 다른 이름 선택 방지
                drawButton.disabled = false; // 추첨 버튼 활성화
                messageDisplay.textContent = `${currentUser}님, 환영합니다! 이제 마니또를 추첨할 수 있습니다.`;
                messageDisplay.style.color = '#3498db';
                resultDisplay.style.display = 'none'; // 혹시 모를 이전 결과 숨김
            } else if (!selected) { // '이름을 선택해주세요' 옵션을 다시 선택한 경우
                drawButton.disabled = true;
                resultDisplay.style.display = 'none';
                messageDisplay.textContent = '이름을 선택해주세요.';
                messageDisplay.style.color = '#555';
            }
        });

        // 마니또 추첨 버튼 클릭 시 동작
        drawButton.addEventListener('click', () => {
            const selectedMember = currentUser; // 현재 고정된 사용자 이름으로 추첨 진행

            if (!selectedMember) {
                messageDisplay.textContent = '먼저 이름을 선택해주세요!';
                messageDisplay.style.color = '#e74c3c';
                resultDisplay.style.display = 'none';
                return;
            }

            if (drawnMembers[selectedMember]) {
                // 이미 추첨한 경우, 저장된 마니또를 다시 보여줌
                manitoNameSpan.textContent = assignedManitos[selectedMember];
                resultDisplay.style.display = 'block';
                messageDisplay.textContent = `당신은 이미 마니또를 추첨하셨습니다. 당신의 마니또는 ${assignedManitos[selectedMember]} 입니다!`;
                messageDisplay.style.color = '#28a745';
                drawButton.disabled = true; // 다시 추첨 못하도록 버튼 비활성화
                return;
            }

            // 마니또 배정 로직: 자신을 제외하고, 아직 누구에게도 배정되지 않은 사람 중에서 선택
            let availableManitos = members.filter(m => 
                m !== selectedMember && 
                !Object.values(assignedManitos).includes(m) 
            );
            
            // 모든 사람이 마니또를 받을 수 있도록 예외 처리:
            // 만약 자신을 제외한 모두가 이미 다른 사람의 마니또로 배정된 경우,
            // 자신을 제외한 모든 팀원 중에서 재할당 (순환 참조 방지 및 전원 배정 목적)
            if (availableManitos.length === 0) {
                availableManitos = members.filter(m => m !== selectedMember);
            }
            
            if (availableManitos.length === 0) {
                messageDisplay.textContent = '더 이상 배정할 마니또가 없습니다. 관리자에게 문의하세요.';
                messageDisplay.style.color = '#e74c3c';
                resultDisplay.style.display = 'none';
                return;
            }

            // 무작위로 마니또 선택
            const randomIndex = Math.floor(Math.random() * availableManitos.length);
            const chosenManito = availableManitos[randomIndex];

            // 결과 저장
            assignedManitos[selectedMember] = chosenManito;
            drawnMembers[selectedMember] = true; 

            localStorage.setItem('assignedManitos', JSON.stringify(assignedManitos));
            localStorage.setItem('drawnMembers', JSON.stringify(drawnMembers));

            // 결과 화면에 표시 및 메시지 업데이트
            manitoNameSpan.textContent = chosenManito;
            resultDisplay.style.display = 'block';
            messageDisplay.textContent = '추첨이 완료되었습니다! 결과를 확인해주세요.';
            messageDisplay.style.color = '#28a745';
            
            // 추첨 후 버튼 비활성화 (한 번만 추첨 가능)
            drawButton.disabled = true; 
        });

        // 관리자 전용 기능 (비밀번호 확인)
        showAdminOptionsButton.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminOptionsDiv.style.display = 'block';
                messageDisplay.textContent = '관리자 옵션이 활성화되었습니다.';
                messageDisplay.style.color = '#3498db';
            } else {
                messageDisplay.textContent = '비밀번호가 올바르지 않습니다.';
                messageDisplay.style.color = '#e74c3c';
                adminOptionsDiv.style.display = 'none';
            }
        });

        // 결과 다운로드 (TXT)
        downloadTxtButton.addEventListener('click', () => {
            let content = "❤️임마누엘교회 마니또❤️ 추첨 결과\n\n";
            for (const member in assignedManitos) {
                content += `${member}: ${assignedManitos[member]}\n`;
            }
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '임마누엘교회_마니또_결과.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // 결과 다운로드 (XLSX)
        downloadXlsxButton.addEventListener('click', () => {
            const data = [["팀원", "마니또"]];
            for (const member in assignedManitos) {
                data.push([member, assignedManitos[member]]);
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "마니또 결과");
            XLSX.writeFile(wb, "임마누엘교회_마니또_결과.xlsx");
        });

        // 모든 기록 초기화
        resetButton.addEventListener('click', () => {
            if (confirm('모든 추첨 기록을 정말로 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                localStorage.removeItem('assignedManitos');
                localStorage.removeItem('drawnMembers');
                localStorage.removeItem('currentUserManitoDrawer'); // 현재 사용자 정보도 함께 초기화
                window.location.reload(); // 페이지 새로고침하여 완전히 초기화된 상태로 만듦
            }
        });
    </script>
</body>
</html>