<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>❤️임마누엘교회 마니또❤️ 추첨기</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            padding: 40px 50px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            border-top: 5px solid #e74c3c;
        }
        h1 {
            color: #e74c3c;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        label {
            display: block;
            margin-bottom: 10px; /* 비밀번호 입력란 위로 조절 */
            font-size: 1.2em;
            color: #555;
            font-weight: 600;
        }
        select, input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px; /* 버튼 위로 조절 */
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1.1em;
            background-color: #f9f9f9;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000%22%20d%3D%22M287%2069.4L146.2%20205.9%205.4%2069.4c-1.8-2.6-4.9-4.2-8.4-4.2H8.4c-3.5%200-6.6%201.6-8.4%204.2l140.8%20164.2c2.2%202.4%205.5%203.8%209%203.8s6.8-1.4%209-3.8l140.8-164.2c-1.8-2.6-4.9-4.2-8.4-4.2h-21.2c-3.5%200-6.6%201.6-8.4%204.2z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 12px;
        }
        button {
            background-color: #e74c3c;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 5px;
            min-width: 150px;
        }
        button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 30px;
            font-size: 1.5em;
            color: #28a745;
            font-weight: bold;
            background-color: #e6ffe6;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #d4ffd4;
            display: none; /* 초기에는 숨김 */
        }
        #message {
            margin-top: 20px;
            font-size: 1.1em;
            color: #555;
        }
        .admin-section {
            margin-top: 40px;
            padding: 30px;
            background-color: #f0f8ff;
            border-radius: 12px;
            border: 1px dashed #a0d2ff;
        }
        .admin-section h2 {
            color: #3498db;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .admin-section input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #b2e0ff;
            border-radius: 6px;
            font-size: 1.1em;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        .admin-section button {
            background-color: #3498db;
            margin-left: 10px;
        }
        .admin-section button:hover {
            background-color: #2980b9;
        }
        @media (max-width: 600px) {
            .container {
                padding: 25px 30px;
            }
            h1 {
                font-size: 2em;
            }
            button {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>❤️임마누엘교회 마니또❤️</h1>
        
        <div class="section">
            <label for="memberName">팀원 선택:</label>
            <select id="memberName">
                <option value="">이름을 선택해주세요</option>
                </select>

            <label for="memberPassword" id="passwordLabel" style="display: none;">비밀번호 (4자리):</label>
            <input type="password" id="memberPassword" maxlength="4" placeholder="비밀번호 4자리" style="display: none;">
            
            <button id="authAndDrawButton">확인 및 마니또 추첨</button>
            <p id="result">당신의 마니또는 <span id="manitoName"></span> 입니다!</p>
            <p id="message"></p>
        </div>

        <div class="admin-section">
            <h2>디렉터 전용</h2>
            <input type="password" id="adminPassword" placeholder="비밀번호를 입력하세요">
            <button id="showAdminOptionsButton">확인</button>
            <div id="adminOptions" style="display: none;">
                <button id="downloadTxtButton">결과 다운로드 (TXT)</button>
                <button id="downloadXlsxButton">결과 다운로드 (XLSX)</button>
                <button id="resetButton">모든 기록 초기화</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const members = [
            "최대규 목사님", "김세록", "전준형", "유병우", "김기경", "유준범", "정헌", "전병훈", 
            "최지현", "허다은", "조재은", "이우진", "권민지", "김지용", "김민상", 
            "박동연", "박상민", "최하은", "김민교", "이단비", "이하은", "장현숙", 
            "유성길", "김예빈", "박주언", "곽해리나", "김기현", "장서연", "김이지", 
            "김재빈", "함이현", "박재민", "이유림"
        ];

        // 각 팀원에게 부여할 4자리 비밀번호 (예시: 임의의 숫자 4자리)
        // 실제 사용 시에는 이 부분을 잘 관리하셔야 합니다.
        // 이 예시 코드에서는 단순성을 위해 난수 기반으로 비밀번호를 생성합니다.
        // 실제 배포 시에는 미리 정해둔 비밀번호를 여기에 직접 입력하거나,
        // 서버에서 안전하게 관리하는 방법을 고려해야 합니다.
        const memberPasswords = JSON.parse(localStorage.getItem('memberPasswords')) || {};
        
        // 비밀번호가 없는 멤버에게만 생성
        members.forEach(member => {
            if (!memberPasswords[member]) {
                memberPasswords[member] = Math.floor(1000 + Math.random() * 9000).toString(); // 1000~9999 사이 4자리 숫자
            }
        });
        localStorage.setItem('memberPasswords', JSON.stringify(memberPasswords)); // 생성된 비밀번호 저장

        const assignedManitos = JSON.parse(localStorage.getItem('assignedManitos')) || {};
        const drawnMembers = JSON.parse(localStorage.getItem('drawnMembers')) || {}; // 한 번 추첨한 사람 기록
        const ADMIN_PASSWORD = "21236688";

        const memberSelect = document.getElementById('memberName');
        const memberPasswordInput = document.getElementById('memberPassword');
        const passwordLabel = document.getElementById('passwordLabel');
        const authAndDrawButton = document.getElementById('authAndDrawButton');
        const resultDisplay = document.getElementById('result');
        const manitoNameSpan = document.getElementById('manitoName');
        const messageDisplay = document.getElementById('message');
        const adminPasswordInput = document.getElementById('adminPassword');
        const showAdminOptionsButton = document.getElementById('showAdminOptionsButton');
        const adminOptionsDiv = document.getElementById('adminOptions');
        const downloadTxtButton = document.getElementById('downloadTxtButton');
        const downloadXlsxButton = document.getElementById('downloadXlsxButton');
        const resetButton = document.getElementById('resetButton');

        let currentAuthenticatedMember = null; // 현재 인증된 사용자

        // 드롭다운 옵션 초기화 (명단 추가)
        function populateMemberSelect() {
            memberSelect.innerHTML = '<option value="">이름을 선택해주세요</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberSelect.appendChild(option);
            });
        }

        // UI 상태 업데이트
        function updateUIState() {
            const selectedMember = memberSelect.value;
            resultDisplay.style.display = 'none'; // 결과는 기본적으로 숨김
            authAndDrawButton.disabled = true; // 버튼 기본 비활성화

            if (!selectedMember) {
                messageDisplay.textContent = '먼저 드롭다운에서 자신의 이름을 선택해주세요.';
                messageDisplay.style.color = '#555';
                passwordLabel.style.display = 'none';
                memberPasswordInput.style.display = 'none';
                memberPasswordInput.value = '';
                currentAuthenticatedMember = null;
                return;
            }

            passwordLabel.style.display = 'block';
            memberPasswordInput.style.display = 'block';
            memberPasswordInput.value = ''; // 이름 변경 시 비밀번호 초기화

            if (currentAuthenticatedMember === selectedMember) {
                // 이미 인증된 사용자라면
                memberSelect.disabled = true; // 이름 선택 고정
                memberPasswordInput.disabled = true; // 비밀번호 입력창 비활성화

                if (drawnMembers[selectedMember]) {
                    // 이미 추첨했다면 결과 표시
                    manitoNameSpan.textContent = assignedManitos[selectedMember];
                    resultDisplay.style.display = 'block';
                    messageDisplay.textContent = `${selectedMember}님, 이미 추첨하셨습니다. 당신의 마니또는 ${assignedManitos[selectedMember]} 입니다!`;
                    messageDisplay.style.color = '#28a745';
                    authAndDrawButton.textContent = '결과 확인';
                    authAndDrawButton.disabled = false;
                } else {
                    // 인증은 되었지만 아직 추첨하지 않았다면 추첨 버튼 활성화
                    messageDisplay.textContent = `${selectedMember}님, 환영합니다! '마니또 추첨' 버튼을 눌러 마니또를 확인하세요.`;
                    messageDisplay.style.color = '#3498db';
                    authAndDrawButton.textContent = '마니또 추첨';
                    authAndDrawButton.disabled = false;
                }
            } else {
                // 이름은 선택했지만 아직 인증되지 않은 상태
                memberSelect.disabled = false; // 이름 다시 선택 가능
                memberPasswordInput.disabled = false; // 비밀번호 입력 활성화
                messageDisplay.textContent = `${selectedMember}님, 비밀번호를 입력하여 본인 확인을 해주세요.`;
                messageDisplay.style.color = '#555';
                authAndDrawButton.textContent = '인증 및 추첨/확인';
                authAndDrawButton.disabled = true; // 비밀번호 입력 전까지 비활성화
            }
        }

        // 페이지 로드 시
        document.addEventListener('DOMContentLoaded', () => {
            populateMemberSelect();
            updateUIState(); // 초기 UI 상태 설정
        });

        // 이름 선택 변경 시
        memberSelect.addEventListener('change', updateUIState);

        // 비밀번호 입력 시 (4자리 모두 입력되면 버튼 활성화)
        memberPasswordInput.addEventListener('input', () => {
            const selectedMember = memberSelect.value;
            const enteredPassword = memberPasswordInput.value;
            if (selectedMember && enteredPassword.length === 4) {
                authAndDrawButton.disabled = false;
            } else {
                authAndDrawButton.disabled = true;
            }
        });

        // 인증 및 추첨 버튼 클릭 시
        authAndDrawButton.addEventListener('click', () => {
            const selectedMember = memberSelect.value;
            const enteredPassword = memberPasswordInput.value;

            if (!selectedMember) {
                messageDisplay.textContent = '이름을 선택해주세요!';
                messageDisplay.style.color = '#e74c3c';
                return;
            }

            // 본인 인증 처리
            if (memberPasswords[selectedMember] !== enteredPassword) {
                messageDisplay.textContent = '비밀번호가 올바르지 않습니다. 다시 입력해주세요.';
                messageDisplay.style.color = '#e74c3c';
                memberPasswordInput.value = ''; // 비밀번호 초기화
                return;
            }

            // 인증 성공!
            currentAuthenticatedMember = selectedMember;
            memberSelect.disabled = true; // 이름 선택 고정
            memberPasswordInput.disabled = true; // 비밀번호 입력 비활성화
            messageDisplay.textContent = `${selectedMember}님, 인증되었습니다.`;
            messageDisplay.style.color = '#28a745';
            
            // 이미 추첨된 경우 결과 표시
            if (drawnMembers[selectedMember]) {
                manitoNameSpan.textContent = assignedManitos[selectedMember];
                resultDisplay.style.display = 'block';
                messageDisplay.textContent = `${selectedMember}님, 이미 추첨하셨습니다. 당신의 마니또는 ${assignedManitos[selectedMember]} 입니다!`;
                messageDisplay.style.color = '#28a745';
                authAndDrawButton.textContent = '결과 확인'; // 버튼 텍스트 변경
                authAndDrawButton.disabled = true; // 결과 보여줬으니 비활성화 (한번만 보여주므로)
                return;
            }

            // 마니또 추첨 로직
            let availableManitos = members.filter(m => 
                m !== selectedMember && 
                !Object.values(assignedManitos).includes(m) 
            );
            
            // 모든 사람이 마니또를 받을 수 있도록 예외 처리 (재할당 로직)
            if (availableManitos.length === 0) {
                 // 자신을 제외한 모든 팀원이 이미 다른 사람의 마니또로 배정된 경우,
                 // 아직 마니또를 배정받지 못한 팀원이 있다면, 그 팀원을 마니또로 선택할 수 있도록 로직 보완
                 // (이 로직은 모든 사람이 마니또를 받을 수 있도록 최후의 수단으로 작동)
                availableManitos = members.filter(m => m !== selectedMember); 
            }
            
            if (availableManitos.length === 0) {
                messageDisplay.textContent = '더 이상 배정할 마니또가 없습니다. 관리자에게 문의하세요.';
                messageDisplay.style.color = '#e74c3c';
                resultDisplay.style.display = 'none';
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableManitos.length);
            const chosenManito = availableManitos[randomIndex];

            // 결과 저장
            assignedManitos[selectedMember] = chosenManito;
            drawnMembers[selectedMember] = true; // 추첨 완료 표시

            localStorage.setItem('assignedManitos', JSON.stringify(assignedManitos));
            localStorage.setItem('drawnMembers', JSON.stringify(drawnMembers));

            // 결과 화면에 표시
            manitoNameSpan.textContent = chosenManito;
            resultDisplay.style.display = 'block';
            messageDisplay.textContent = `추첨이 완료되었습니다! ${selectedMember}님의 마니또는 ${chosenManito} 입니다! 결과는 위를 확인해주세요.`;
            messageDisplay.style.color = '#28a745';
            
            authAndDrawButton.disabled = true; // 추첨 후 버튼 비활성화 (1회만 추첨 가능)
            authAndDrawButton.textContent = '추첨 완료';
        });

        // 관리자 섹션 비밀번호 확인
        showAdminOptionsButton.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminOptionsDiv.style.display = 'block';
                messageDisplay.textContent = '관리자 옵션이 활성화되었습니다.';
                messageDisplay.style.color = '#3498db';
            } else {
                messageDisplay.textContent = '비밀번호가 올바르지 않습니다.';
                messageDisplay.style.color = '#e74c3c';
                adminOptionsDiv.style.display = 'none';
            }
        });

        // 결과 다운로드 (TXT)
        downloadTxtButton.addEventListener('click', () => {
            let content = "❤️임마누엘교회 마니또❤️ 추첨 결과\n\n";
            content += "===== 마니또 배정 결과 =====\n";
            for (const member in assignedManitos) {
                content += `${member}: ${assignedManitos[member]}\n`;
            }
            content += "\n===== 팀원별 비밀번호 (디렉터 전용) =====\n";
            for (const member in memberPasswords) {
                content += `${member}: ${memberPasswords[member]}\n`;
            }
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '임마누엘교회_마니또_결과_및_비밀번호.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // 결과 다운로드 (XLSX)
        downloadXlsxButton.addEventListener('click', () => {
            const data = [["팀원", "마니또"], ["", ""]]; // 빈 줄 추가
            for (const member in assignedManitos) {
                data.push([member, assignedManitos[member]]);
            }

            data.push(["", ""]); // 구분선
            data.push(["팀원", "비밀번호"]); // 비밀번호 헤더
            for (const member in memberPasswords) {
                data.push([member, memberPasswords[member]]);
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "마니또 결과");
            XLSX.writeFile(wb, "임마누엘교회_마니또_결과_및_비밀번호.xlsx");
        });

        // 모든 기록 초기화
        resetButton.addEventListener('click', () => {
            if (confirm('모든 추첨 기록과 비밀번호를 정말로 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                localStorage.removeItem('assignedManitos');
                localStorage.removeItem('drawnMembers');
                localStorage.removeItem('memberPasswords'); // 비밀번호도 초기화
                localStorage.removeItem('currentUserManitoDrawer'); // 현재 로그인 사용자 정보도 초기화
                window.location.reload(); 
            }
        });
    </script>
</body>
</html>